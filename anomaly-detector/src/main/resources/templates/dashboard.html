<!DOCTYPE html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Tableau de Bord des Anomalies</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .card-header { font-weight: 500; }
        .form-correction { display: inline-flex; gap: 5px; align-items: center; }
        .statut-VALIDEE { background-color: #d1e7dd !important; color: #0f5132 !important; }
        .statut-REJETEE { background-color: #f8d7da !important; color: #842029 !important; }
        .statut-RESOLUE { background-color: #cff4fc !important; color: #055160 !important; }
        
        /* === RÈGLES CSS CORRIGÉES === */
        .message-cell p { font-size: 0.9rem; margin-bottom: 0.25rem !important; }
        .message-cell .suggestion { font-size: 0.85rem; color: #0d6efd; font-weight: bold; }
    </style>
</head>
<body>

<div class="container-fluid mt-4">
    <h3 class="mb-4" th:text="${titre}">Tableau de Bord</h3>

    <!-- Tableau "À Traiter" -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-warning">
            <i class="bi bi-exclamation-triangle-fill"></i> Anomalies à Traiter
            <span class="badge bg-dark float-end" th:text="${#lists.size(anomalies)}">0</span>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover table-sm align-middle mb-0">
                    <thead>
                        <tr>
                            <th>Jour</th>
                            <th>Employé</th>
                            <th>Type</th>
                            <th>Message & Suggestion IA</th>
                            <th style="width: 220px;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:if="${#lists.isEmpty(anomalies)}"><td colspan="5" class="text-center text-muted p-4">Félicitations, aucune anomalie à traiter !</td></tr>
                        <tr th:each="ano : ${anomalies}">
                            <td th:text="${ano.jourAnomalie}"></td>
                            <td th:text="${ano.nomEmploye}"></td>
                            <td><span class="badge bg-danger" th:text="${ano.typeAnomalie}"></span></td>
                            <td class="message-cell">
                                <p th:text="${ano.message}"></p>
                                <em class="suggestion" th:text="${ano.suggestion}"></em>
                            </td>
                            <td>
                                <!-- === LOGIQUE DES BOUTONS === -->
                                <div th:if="${ano.typeAnomalie == 'ABSENCE_INJUSTIFIEE'}">
                                    <button title="Confirmer comme absence injustifiée" class="btn btn-outline-danger btn-sm" th:onclick="'simpleAction(this, \'' + @{/api/anomalies/{id}/valider-manuellement(id=${ano.id})} + '\', \'Confirmée comme Injustifiée\')'"><i class="bi bi-shield-slash"></i> Confirmer</button>
                                    <button title="Requalifier (rejeter l'anomalie d'absence)" class="btn btn-outline-secondary btn-sm" th:onclick="'simpleAction(this, \'' + @{/api/anomalies/{id}/rejeter-manuellement(id=${ano.id})} + '\', \'Requalifiée\')'"><i class="bi bi-pencil-square"></i> Requalifier</button>
                                </div>
                                <div th:if="${ano.typeAnomalie == 'OMISSION_POINTAGE'}">
                                    <button title="Accepter la suggestion de l'IA" class="btn btn-success btn-sm" th:onclick="'simpleAction(this, \'' + @{/api/anomalies/{id}/accepter-suggestion(id=${ano.id})} + '\')'"><i class="bi bi-robot"></i> Accepter IA</button>
                                    <form class="form-correction mt-1" onsubmit="handleCorrectionSubmit(event)">
                                        <input type="hidden" name="actionUrl" th:value="@{/api/anomalies/{id}/corriger-manuellement(id=${ano.id})}">
                                        <input type="time" name="heureCorrigee" class="form-control form-control-sm" style="width: 100px;" th:value="${ano.valeurSuggestion}" required>
                                        <button type="submit" title="Corriger manuellement" class="btn btn-secondary btn-sm"><i class="bi bi-tools"></i></button>
                                    </form>
                                </div>
                                <div th:if="${ano.typeAnomalie != 'ABSENCE_INJUSTIFIEE' and ano.typeAnomalie != 'OMISSION_POINTAGE'}">
                                    <button title="Accepter l'anomalie (ex: valider un retard)" class="btn btn-success btn-sm" th:onclick="'simpleAction(this, \'' + @{/api/anomalies/{id}/valider-manuellement(id=${ano.id})} + '\')'"><i class="bi bi-check-lg"></i> Valider</button>
                                    <button title="Rejeter l'anomalie" class="btn btn-danger btn-sm" th:onclick="'simpleAction(this, \'' + @{/api/anomalies/{id}/rejeter-manuellement(id=${ano.id})} + '\')'"><i class="bi bi-x-lg"></i> Rejeter</button>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- === SECTION HISTORIQUE RESTAURÉE === -->
    <div class="card shadow-sm">
        <div class="card-header bg-info text-white"><i class="bi bi-clock-history"></i> Historique des Anomalies Traitées</div>
        <div class="card-body p-0">
             <div class="table-responsive">
                <table class="table table-sm align-middle mb-0">
                    <thead><tr><th>Jour</th><th>Employé</th><th>Type</th><th>Statut</th><th class="message-cell">Détails du Traitement</th></tr></thead>
                    <tbody>
                        <tr th:if="${#lists.isEmpty(historique)}"><td colspan="5" class="text-center text-muted p-4">Aucun historique.</td></tr>
                        <tr th:each="histo : ${historique}">
                            <td th:text="${histo.jourAnomalie}"></td>
                            <td th:text="${histo.nomEmploye}"></td>
                            <td th:text="${histo.typeAnomalie}"></td>
                            <td><span class="badge" th:classappend="'statut-' + ${histo.statut}" th:text="${histo.statut}"></span></td>
                            <td class="message-cell">
                                <p th:text="${histo.message}"></p>
                                <small class="text-muted" th:text="${histo.commentaireValidation}"></small>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Le JavaScript reste inchangé, il est déjà correct -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script th:inline="javascript">
/*<![CDATA[*/
    function handleApiResponse(response) {
        if (response.ok) { location.reload(); } 
        else {
            alert("Erreur: L'action a échoué.");
            document.querySelectorAll('button').forEach(b => b.disabled = false);
        }
    }
    function simpleAction(button, url, commentaire = "Action depuis le tableau de bord.") {
        button.closest('tr').querySelectorAll('button').forEach(b => b.disabled = true);
        fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ commentaire: commentaire })
        }).then(handleApiResponse);
    }
    function handleCorrectionSubmit(event) {
        event.preventDefault();
        const form = event.target;
        form.closest('tr').querySelectorAll('button').forEach(b => b.disabled = true);
        const url = form.querySelector('input[name=actionUrl]').value;
        const body = {
            heureCorrigee: form.querySelector('input[name=heureCorrigee]').value,
            commentaire: "Correction manuelle depuis le tableau de bord."
        };
        fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        }).then(handleApiResponse);
    }
/*]]>*/
</script>
</body>
</html>